# איפיון טכני מפורט - מערכת טוטו שלוש

## תוכן עניינים
1. [סקירה כללית](#סקירה-כללית)
2. [ארכיטקטורת המערכת](#ארכיטקטורת-המערכת)
3. [טכנולוגיות ושירותים](#טכנולוגיות-ושירותים)
4. [מבנה הנתונים](#מבנה-הנתונים)
5. [API Endpoints](#api-endpoints)
6. [ממשק המשתמש](#ממשק-המשתמש)
7. [ניהול נתונים](#ניהול-נתונים)
8. [אבטחה](#אבטחה)
9. [מערכת גיבויים](#מערכת-גיבויים)
10. [מעקב ובקרה](#מעקב-ובקרה)
11. [הגדרת סביבה](#הגדרת-סביבה)
12. [תחזוקה ופיתוח](#תחזוקה-ופיתוח)

---

## סקירה כללית

### מטרת המערכת
מערכת טוטו שלוש היא אפליקציית Web לניהול טופסי טוטו 16 קבוצתיים. המערכת מאפשרת לקבוצת חברים לנהל משחק טוטו שבועי, להזין ניחושים, לעקוב אחר תוצאות ולצבור ניקוד אישי.

### קהל יעד
- קבוצות חברים (עד 50 משתתפים)
- קבוצות משפחתיות
- קבוצות עובדים/סטודנטים
- אין צורך בהרשמה - כניסה ישירה

### דרישות עיקריות
- ניהול 16 משחקי טוטו שבועיים
- הזנת ניחושים (1/X/2)
- חישוב ניקוד אוטומטי
- טבלת דירוג דינמית
- ממשק ניהול למנהל
- מערכת גיבויים אוטומטית

---

## ארכיטקטורת המערכת

### ארכיטקטורה כללית
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Database      │
│   (Next.js)     │◄──►│   (API Routes)  │◄──►│   (Vercel KV)   │
│                 │    │                 │    │                 │
│ • React 18      │    │ • Node.js       │    │ • Redis-like    │
│ • TypeScript    │    │ • Rate Limiting │    │ • Key-Value     │
│ • Tailwind CSS  │    │ • Validation    │    │ • Persistent    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### מבנה הפרויקט
```
toto-shlush-modern/
├── app/                          # Next.js App Router
│   ├── api/                      # API Endpoints
│   ├── components/               # React Components
│   ├── hooks/                    # Custom Hooks
│   ├── admin/                    # Admin Panel
│   └── pages/                    # Application Pages
├── src/                          # TypeScript Source
│   ├── lib/                      # Core Libraries
│   ├── types/                    # Type Definitions
│   └── hooks/                    # TypeScript Hooks
├── public/                       # Static Assets
└── backups/                      # Backup Storage
```

### זרימת נתונים
```
User Interface
     ↓
React Components
     ↓
Custom Hooks (useHomeData, useGuessData)
     ↓
DataManager (Singleton)
     ↓
ApiClient
     ↓
API Routes (/api/*)
     ↓
Vercel KV Database
```

---

## טכנולוגיות ושירותים

### Frontend Stack
- **Next.js 14.2.32** - React Framework עם App Router
- **React 18.3.1** - UI Library
- **TypeScript 5.9.2** - Type Safety
- **Tailwind CSS 3.4.17** - Styling Framework
- **Lucide React** - Icon Library

### Backend Stack
- **Next.js API Routes** - Server-side API
- **Node.js 18.17.0+** - Runtime Environment
- **Vercel KV** - Key-Value Database
- **Upstash Redis** - Alternative Database

### DevOps & Monitoring
- **Vercel** - Hosting & Deployment
- **Sentry** - Error Tracking & Performance
- **Vercel Analytics** - User Analytics
- **Uptime Robot** - System Monitoring

### Development Tools
- **PostCSS** - CSS Processing
- **Autoprefixer** - CSS Vendor Prefixes
- **ESLint** - Code Linting

---

## מבנה הנתונים

### Core Entities

#### User (משתמש)
```typescript
interface User {
  id: string;                    // מזהה ייחודי
  name: string;                  // שם המשתמש
  phone?: string;                // מספר טלפון
  isAdmin?: boolean;             // הרשאות מנהל
  paymentStatus: PaymentStatus;  // סטטוס תשלום
  createdAt: string;             // תאריך יצירה
  updatedAt: string;             // תאריך עדכון אחרון
}
```

#### Match (משחק)
```typescript
interface Match {
  id: string;                    // מזהה ייחודי
  homeTeam: string;              // קבוצה ביתית
  awayTeam: string;              // קבוצה חיצונית
  date?: string;                 // תאריך המשחק
  time?: string;                 // שעת המשחק
  result?: string;               // תוצאת המשחק (1/X/2)
  category: string;              // קטגוריה (טוטו 16)
  league?: string;               // ליגה
  day?: string;                  // יום בשבוע
  week?: number;                 // מספר שבוע
  createdAt: string;             // תאריך יצירה
  updatedAt: string;             // תאריך עדכון אחרון
}
```

#### UserGuess (ניחוש משתמש)
```typescript
interface UserGuess {
  id: string;                    // מזהה ייחודי
  userId: string;                // מזהה המשתמש
  name: string;                  // שם המשתמש
  phone?: string;                // מספר טלפון
  guesses: string[];             // מערך ניחושים (16 ערכים)
  score: number;                 // ניקוד נוכחי
  correct: boolean[];            // מערך תוצאות נכונות
  paymentStatus: PaymentStatus;  // סטטוס תשלום
  week: number;                  // מספר שבוע
  createdAt: string;             // תאריך יצירה
  updatedAt: string;             // תאריך עדכון אחרון
}
```

#### Settings (הגדרות מערכת)
```typescript
interface Settings {
  adminPassword: string;         // סיסמת מנהל
  entryFee: number;              // דמי השתתפות
  totoFirstPrize: number;        // פרס ראשון בטוטו
  submissionsLocked: boolean;    // נעילת הגשות
  countdownActive: boolean;      // שעון ספירה לאחור
  countdownTarget: string;       // יעד השעון
  adminEmail?: string;           // אימייל מנהל
  currentWeek: number;           // שבוע נוכחי
}
```

### Enums
```typescript
enum PaymentStatus {
  UNPAID = 'unpaid',
  PAID = 'paid',
  PENDING = 'pending'
}

enum MatchResult {
  HOME_WIN = '1',
  DRAW = 'X',
  AWAY_WIN = '2'
}
```

### Database Schema (Vercel KV)
```
Key Structure:
├── toto:data:v1              # נתונים ראשיים
├── toto:meta:v1              # הגדרות מערכת
├── toto:users:v1             # רשימת משתמשים
├── toto:week:1:matches:v1    # משחקים לשבוע 1
└── toto:week:1:guesses:v1    # ניחושים לשבוע 1
```

---

## API Endpoints

### Core Data Endpoints

#### GET /api/data
**תיאור**: קבלת כל נתוני המערכת
**פרמטרים**:
- `fields` - שדות ספציפיים (אופציונלי)
- `legacy=true` - נתונים בפורמט ישן
- `diag=1` - מידע אבחון

**תגובה**:
```json
{
  "users": User[],
  "matches": Match[],
  "userGuesses": UserGuess[],
  "settings": Settings
}
```

#### PUT /api/data
**תיאור**: עדכון נתוני המערכת
**Headers**:
- `x-admin-token` - טוקן מנהל (לאופציות רגישות)
- `x-action` - סוג פעולה

**Body**: נתונים לעדכון

#### POST /api/data
**תיאור**: פעולות מיוחדות על נתונים
**Actions**:
- `status` - סטטוס בסיס הנתונים
- `cleanup` - ניקוי נתונים כפולים
- `clearAll` - מחיקת כל הנתונים

### User Management

#### POST /api/add-guess
**תיאור**: הוספת ניחוש חדש
**Body**:
```json
{
  "name": "string",
  "guesses": ["1", "X", "2", ...]
}
```

#### PUT /api/update-guess/:id
**תיאור**: עדכון ניחוש קיים

#### DELETE /api/delete-guess/:id
**תיאור**: מחיקת ניחוש

### Match Management

#### POST /api/add-match
**תיאור**: הוספת משחק חדש
**Body**:
```json
{
  "homeTeam": "string",
  "awayTeam": "string",
  "date": "string",
  "time": "string"
}
```

#### PUT /api/update-match/:id
**תיאור**: עדכון משחק (בעיקר תוצאות)

#### DELETE /api/delete-match/:id
**תיאור**: מחיקת משחק

### Admin Operations

#### PUT /api/update-settings
**תיאור**: עדכון הגדרות מערכת
**Headers**: `x-admin-token` (חובה)

#### POST /api/create-default-matches
**תיאור**: יצירת 16 משחקים ברירת מחדל

#### DELETE /api/clear-guesses
**תיאור**: מחיקת כל הניחושים

#### DELETE /api/clear-matches
**תיאור**: מחיקת כל המשחקים

### Backup System

#### GET /api/backup
**תיאור**: רשימת גיבויים זמינים

#### POST /api/backup
**תיאור**: יצירת גיבוי חדש
**Actions**:
- `create` - יצירת גיבוי
- `restore` - שחזור גיבוי

#### DELETE /api/backup
**תיאור**: מחיקת גיבוי

### Utility Endpoints

#### GET /api/health
**תיאור**: בדיקת תקינות המערכת

#### GET /api/leaderboard
**תיאור**: טבלת דירוג

#### GET /api/pot
**תיאור**: חישוב הקופה

---

## ממשק המשתמש

### Page Structure

#### דף הבית (/)
- **Header**: לוגו, שם המערכת, כפתור רענון
- **PotInfo**: מידע על הקופה (מספר משתתפים, סכום)
- **CountdownTimer**: שעון ספירה לאחור (אם פעיל)
- **LeaderboardPreview**: תצוגה מקדימה של הדירוג (3 ראשונים)
- **MatchesPreview**: תצוגה מקדימה של המשחקים לפי ימים
- **ActionButtons**: כפתורי ניווט עיקריים

#### דף הזנת ניחושים (/guess)
- **PersonalDetailsForm**: שם וטלפון
- **GuessForm**: 16 שורות ניחושים (1/X/2)
- **SubmitButton**: שליחת הטופס
- **SuccessMessage**: הודעת הצלחה

#### דף דירוג (/leaderboard)
- **LeaderboardHeader**: כותרת ומידע כללי
- **PotDisplay**: תצוגת הקופה
- **LeaderboardTable**: טבלת דירוג מלאה
- **LeaderboardActions**: פעולות נוספות

#### פאנל ניהול (/admin)
- **AdminHeader**: כותרת ומידע מנהל
- **AdminTabs**: טאבים לניהול
  - משחקים (MatchesTab)
  - משתתפים (ParticipantsTab)
  - משתמשים (UsersTab)
  - גיבויים (BackupsTab)
  - הגדרות (SettingsTab)

### Component Architecture

#### Shared Components
```
shared/
├── PageHeader.jsx           # כותרת דף כללית
├── EmptyState.jsx           # מצב ריק
├── LoadingSpinner.jsx       # אנימציית טעינה
├── ConfirmDialog.jsx        # דיאלוג אישור
├── Toast.jsx               # הודעות מערכת
└── ErrorBoundary.jsx       # טיפול בשגיאות
```

#### Page-Specific Components
```
components/
├── HomeHeader.jsx          # כותרת דף הבית
├── PotInfo.jsx            # מידע קופה
├── CountdownTimer.jsx     # שעון ספירה
├── GuessForm.jsx          # טופס ניחושים
├── LeaderboardTable.jsx   # טבלת דירוג
└── admin/                 # רכיבי ניהול
```

### Responsive Design
- **Mobile First**: עיצוב מתחיל במובייל
- **Breakpoints**: sm (640px), md (768px), lg (1024px)
- **RTL Support**: תמיכה מלאה בעברית
- **Touch Friendly**: כפתורים גדולים למגע

---

## ניהול נתונים

### DataManager Architecture

#### Singleton Pattern
```typescript
class DataManager {
  private static instance: DataManager;
  private cache: Map<string, CacheEntry>;
  private data: SystemData | null;
  
  static getInstance(): DataManager {
    if (!DataManager.instance) {
      DataManager.instance = new DataManager();
    }
    return DataManager.instance;
  }
}
```

#### Caching Strategy
```typescript
interface CacheEntry {
  data: any;
  timestamp: number;
  ttl: number; // Time To Live in milliseconds
}

// Cache TTL Configuration:
- Users: 1 minute
- Matches: 1 minute  
- UserGuesses: 1 minute
- Settings: 5 minutes
- Leaderboard: 30 seconds
```

#### Data Flow
1. **Initialize**: טעינת נתונים מהשרת
2. **Cache Check**: בדיקת cache לפני קריאה לשרת
3. **Server Request**: קריאה לשרת אם cache לא קיים
4. **Data Processing**: עיבוד ונירמול נתונים
5. **Cache Update**: עדכון cache עם TTL
6. **Return Data**: החזרת נתונים לממשק

### Data Validation

#### Input Validation
```typescript
// שם משתמש
validateName(name: string): {
  isValid: boolean;
  error?: string;
}

// מספר טלפון
validatePhone(phone: string): {
  isValid: boolean;
  error?: string;
}

// ניחושים
validateGuesses(guesses: string[]): {
  isValid: boolean;
  error?: string;
}
```

#### Data Normalization
- הסרת כפילויות במשתמשים
- תיקון IDs חסרים
- הוספת timestamps חסרים
- נירמול paymentStatus

### Error Handling

#### Error Types
```typescript
interface AppError {
  code: string;
  message: string;
  details?: any;
}

// Error Categories:
- VALIDATION_ERROR
- NETWORK_ERROR  
- SERVER_ERROR
- AUTHENTICATION_ERROR
- NOT_FOUND_ERROR
```

#### Error Recovery
- Retry mechanism for network errors
- Fallback to cached data
- User-friendly error messages
- Automatic retry with exponential backoff

---

## אבטחה

### Rate Limiting
```typescript
// Rate Limits per IP:
- GET requests: 100/minute
- PUT requests: 50/minute
- POST requests: 30/minute
- Admin operations: 10/minute
```

### Authentication
```typescript
// Admin Authentication
- Password-based authentication
- Token-based API access (ADMIN_TOKEN)
- Session management for admin panel

// User Authentication  
- No registration required
- Name-based identification
- Automatic user creation
```

### Input Sanitization
```typescript
// Security Measures:
- XSS prevention
- SQL injection prevention (KV is NoSQL)
- Input length limits
- Character validation
- HTML entity encoding
```

### Data Protection
- HTTPS only (Vercel enforced)
- Environment variables for secrets
- No sensitive data in client-side code
- Secure headers configuration

---

## מערכת גיבויים

### Backup Architecture

#### Automatic Backups
```typescript
// Backup Triggers:
- User submits guess (forced)
- Admin updates settings
- Admin modifies matches
- Admin changes user data
- Every 5 minutes (if changes occurred)

// Backup Frequency Control:
- Minimum 2 seconds between backups
- Maximum 1 backup per action
- Rate limiting protection
```

#### Backup Structure
```typescript
interface BackupData {
  timestamp: string;
  data: {
    users: User[];
    matches: Match[];
    userGuesses: UserGuess[];
    settings: Settings;
  };
  metadata: {
    version: string;
    totalSize: number;
    userCount: number;
    matchCount: number;
    guessCount: number;
  };
}
```

#### Backup Storage
```
backups/
├── backup-{timestamp}/
│   ├── full-backup.json      # גיבוי מלא
│   ├── local-backup.json     # גיבוי מקומי
│   └── README.md            # מידע על הגיבוי
```

### Restore Process

#### Backup Validation
1. Structure validation
2. Data integrity check
3. Version compatibility
4. Size verification

#### Restore Steps
1. Create safety backup
2. Clear existing data
3. Restore matches
4. Restore users
5. Restore settings
6. Restore guesses
7. Validate restored data
8. Create confirmation backup

---

## מעקב ובקרה

### Monitoring Stack

#### Sentry Integration
```typescript
// Error Tracking:
- JavaScript/React errors
- API endpoint errors
- Performance monitoring
- Session replay
- Source maps for debugging

// Configuration:
- Project: atzmai/javascript-nextjs
- Tunnel route: /monitoring
- Auto-instrumentation enabled
```

#### Vercel Analytics
```typescript
// User Analytics:
- Page views and unique visitors
- Core Web Vitals (LCP, FID, CLS)
- Real-time traffic data
- Geographic distribution
- Device and browser analytics
```

#### Uptime Robot
```typescript
// System Monitoring:
- Main App: https://toto-shlush-modern.vercel.app
- Health Check: /api/health
- API Data: /api/data
- 5-minute monitoring intervals
- Email and SMS alerts
```

### Health Check System

#### /api/health Endpoint
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 3600,
  "checks": {
    "redis": {
      "status": "healthy",
      "responseTime": 15
    },
    "memory": {
      "status": "healthy", 
      "used": "45MB",
      "total": "128MB"
    },
    "environment": {
      "status": "healthy",
      "nodeVersion": "v18.17.0",
      "platform": "linux"
    },
    "api": {
      "status": "healthy",
      "responseTime": 25,
      "hasData": true
    }
  }
}
```

---

## הגדרת סביבה

### Environment Variables

#### Required Variables
```bash
# Vercel KV Database
KV_REST_API_URL=https://your-kv-url
KV_REST_API_TOKEN=your-kv-token

# Admin Security
ADMIN_TOKEN=your-admin-token

# Sentry (Optional)
SENTRY_DSN=your-sentry-dsn
SENTRY_ORG=your-org
SENTRY_PROJECT=your-project
```

#### Development Setup
```bash
# Install dependencies
npm install

# Setup local KV
npm run setup-kv

# Start development server
npm run dev

# Access application
http://localhost:3001
```

### Deployment Configuration

#### Vercel Configuration
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "env": {
    "KV_REST_API_URL": "@kv_rest_api_url",
    "KV_REST_API_TOKEN": "@kv_rest_api_token"
  }
}
```

#### Build Configuration
```javascript
// next.config.js
const nextConfig = {
  experimental: {
    typedRoutes: true,
  },
  webpack: (config) => {
    config.resolve.alias = {
      ...config.resolve.alias,
      '@': require('path').resolve(__dirname, 'src'),
    };
    return config;
  },
}
```

---

## תחזוקה ופיתוח

### Development Workflow

#### Code Structure
```
src/
├── lib/
│   ├── data-manager.ts      # ניהול נתונים מרכזי
│   ├── api-client.ts        # לקוח API
│   ├── utils.ts            # פונקציות עזר
│   └── constants.ts        # קבועים
├── types/
│   └── index.ts           # הגדרות טיפוסים
└── hooks/
    └── useHomeData.ts     # Hook לנתוני בית
```

#### Custom Hooks
```typescript
// useHomeData Hook
interface HomeData {
  pot: Pot;
  leaderboard: LeaderboardEntry[];
  matches: Match[];
  isRefreshing: boolean;
  countdown: Countdown;
  settings: Settings;
  topScore: number | null;
  matchesByDay: MatchesByDay;
  refreshData: () => Promise<void>;
}
```

### Testing Strategy

#### Manual Testing Checklist
- [ ] הזנת ניחוש חדש
- [ ] עדכון ניחוש קיים
- [ ] מחיקת ניחוש
- [ ] הוספת משחק חדש
- [ ] עדכון תוצאות משחק
- [ ] מחיקת משחק
- [ ] יצירת גיבוי
- [ ] שחזור גיבוי
- [ ] עדכון הגדרות
- [ ] בדיקת דירוג

#### Performance Monitoring
- Response times < 200ms
- Database queries < 100ms
- Cache hit ratio > 80%
- Error rate < 1%

### Maintenance Tasks

#### Daily
- [ ] בדיקת health endpoint
- [ ] בדיקת גיבויים אוטומטיים
- [ ] מעקב אחר שגיאות Sentry

#### Weekly  
- [ ] בדיקת ביצועים
- [ ] ניקוי cache ישן
- [ ] עדכון dependencies

#### Monthly
- [ ] בדיקת אבטחה
- [ ] ניתוח שימוש
- [ ] אופטימיזציה

### Troubleshooting

#### Common Issues

**Database Connection Issues**
```bash
# Check environment variables
curl /api/data?diag=1

# Test KV connection
curl /api/health
```

**Performance Issues**
```bash
# Check cache status
curl /api/data?fields=users,matches

# Monitor response times
# Check Vercel Analytics
```

**Data Corruption**
```bash
# Clean up duplicates
POST /api/data { "action": "cleanup" }

# Restore from backup
POST /api/backup { "action": "restore", "backupId": "..." }
```

---

## סיכום טכני

### נקודות חוזק
1. **ארכיטקטורה מודרנית**: Next.js 14 עם App Router
2. **Type Safety**: TypeScript מלא עם הגדרות מפורטות
3. **Scalability**: Vercel KV עם cache מתקדם
4. **Monitoring**: מעקב מקיף עם Sentry ו-Vercel Analytics
5. **Backup System**: מערכת גיבויים אוטומטית ומתקדמת
6. **Security**: Rate limiting, validation, ו-authentication
7. **Performance**: Cache strategy עם TTL מתקדם

### נקודות לשיפור
1. **Testing**: הוספת unit tests ו-integration tests
2. **Documentation**: API documentation מפורטת יותר
3. **CI/CD**: אוטומציה של deployment ו-testing
4. **Caching**: Redis cluster לפרודקשן
5. **Monitoring**: הוספת custom metrics
6. **Security**: הוספת 2FA למנהלים

### המלצות לפיתוח עתידי
1. **Microservices**: פיצול למיקרו-שירותים לפי domain
2. **Real-time**: WebSocket לתצוגה בזמן אמת
3. **Mobile App**: אפליקציה נטיבית
4. **Analytics**: מערכת analytics מתקדמת
5. **AI Features**: ניבוי תוצאות עם ML
6. **Social Features**: שיתוף ניחושים ברשתות חברתיות

---

*איפיון זה נכתב על בסיס ניתוח מקיף של הקוד והמערכת הקיימת. המערכת פועלת בפרודקשן ב-https://toto-shlush-modern.vercel.app*
