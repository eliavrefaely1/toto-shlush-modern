# מערכת גיבויים - טוטו שלוש

## סקירה כללית

מערכת הגיבויים המתקדמת מאפשרת לך ליצור גיבויים אוטומטיים וידניים של כל הנתונים במערכת, לשחזר אותם במידת הצורך, ולשלוח אותם למייל אוטומטית.

## תכונות המערכת

### 🔄 גיבוי אוטומטי
- **תדירות**: כל 5 דקות לאחר שינויים במערכת
- **טריגר**: כל פעולת שמירה במערכת (הוספת משתמש, ניחוש, עדכון משחק וכו')
- **מיקום**: תיקיית `./backups/` בפרויקט

### 📁 מבנה הגיבוי
כל גיבוי כולל:
- **full-backup.json**: קובץ JSON עם כל הנתונים
- **README.md**: תיעוד הגיבוי עם פרטים וזמן יצירה
- **תיקייה ייחודית**: `backup-YYYY-MM-DDTHH-MM-SS-sssZ`

### 📊 נתונים שנשמרים
- **נתונים ראשיים**: משחקים, משתמשים, ניחושים
- **נתוני מטא**: הגדרות מערכת, גרסה, זמן שינוי אחרון
- **נתוני משתמשים**: פרטים אישיים, סטטוס תשלום
- **נתונים לפי שבועות**: ניחושים ומשחקים לכל שבוע (1-10)
- **סטטיסטיקות**: מספר גיבויים, גודל נתונים

## שיטות שימוש

### 1. ממשק ווב (מומלץ למשתמשים רגילים)

#### גישה למנהל הגיבויים:
```
http://localhost:3001/backup-manager
```

#### פעולות זמינות:
- **צור גיבוי חדש**: יצירת גיבוי ידני
- **רענן רשימה**: עדכון רשימת הגיבויים
- **שחזר**: שחזור מגיבוי קיים
- **מחק**: מחיקת גיבוי ישן

### 2. API ישיר (למפתחים)

#### יצירת גיבוי:
```bash
curl -X GET "http://localhost:3001/api/backup?action=create"
```

#### רשימת גיבויים:
```bash
curl -X GET "http://localhost:3001/api/backup?action=list"
```

#### שחזור מגיבוי:
```bash
curl -X POST "http://localhost:3001/api/backup" \
  -H "Content-Type: application/json" \
  -H "x-admin-token: YOUR_ADMIN_TOKEN" \
  -d '{
    "action": "restore",
    "backupData": { /* נתוני הגיבוי */ }
  }'
```

#### מחיקת גיבוי:
```bash
curl -X POST "http://localhost:3001/api/backup" \
  -H "Content-Type: application/json" \
  -H "x-admin-token: YOUR_ADMIN_TOKEN" \
  -d '{
    "action": "delete",
    "backupName": "backup-2025-01-27T10-30-00-000Z"
  }'
```

### 3. סקריפט טרמינל (למנהלי מערכת)

#### התקנה:
```bash
# וודא שהסקריפט ניתן להרצה
chmod +x scripts/backup-manager.js
```

#### יצירת גיבוי:
```bash
node scripts/backup-manager.js create
```

#### רשימת גיבויים:
```bash
node scripts/backup-manager.js list
```

#### שחזור מגיבוי:
```bash
node scripts/backup-manager.js restore
```

#### מחיקת גיבוי:
```bash
node scripts/backup-manager.js delete
```

#### עזרה:
```bash
node scripts/backup-manager.js help
```

## תרחישי שימוש

### 🆘 שחזור לאחר תקלה
1. **זיהוי הבעיה**: נתונים נמחקו או נפגמו
2. **בחירת גיבוי**: בחר את הגיבוי האחרון לפני הבעיה
3. **שחזור**: השתמש באחת מהשיטות לעיל
4. **בדיקה**: ודא שהנתונים שוחזרו כראוי

### 📦 גיבוי לפני עדכון
1. **יצירת גיבוי ידני**: לפני ביצוע שינויים גדולים
2. **שמירה חיצונית**: העתק את תיקיית הגיבוי למקום בטוח
3. **ביצוע העדכון**: בצע את השינויים הנדרשים
4. **בדיקה**: ודא שהמערכת עובדת כראוי

### 🧹 ניקוי גיבויים ישנים
1. **בדיקת גיבויים**: רשימת כל הגיבויים הקיימים
2. **בחירת גיבויים למחיקה**: גיבויים ישנים או לא רלוונטיים
3. **מחיקה**: הסר את הגיבויים המיותרים

## הגדרות ואבטחה

### 🔐 טוקן אדמין
לפעולות רגישות (שחזור, מחיקה) נדרש טוקן אדמין:

```bash
# הגדרת משתנה סביבה
export ADMIN_TOKEN="your-secret-token"

# או בקובץ .env.local
ADMIN_TOKEN=your-secret-token
```

### 📧 שליחת מיילים אוטומטית
המערכת יכולה לשלוח גיבויים למייל אוטומטית:

```bash
# הגדרת משתני סביבה
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ADMIN_EMAIL=your-email@example.com
```

### 📁 מיקום גיבויים
- **ברירת מחדל**: `./backups/`
- **שינוי מיקום**: ערוך את `BACKUP_DIR` ב-`app/api/backup/route.js`

### ⏰ תדירות גיבוי אוטומטי
- **ברירת מחדל**: כל 5 דקות
- **שינוי תדירות**: ערוך את `_backupInterval` ב-`src/lib/data-manager.ts`

## פתרון בעיות

### ❌ שגיאות נפוצות

#### "Unauthorized"
- **סיבה**: חסר או שגוי טוקן אדמין
- **פתרון**: ודא שהטוקן מוגדר נכון

#### "Backup not found"
- **סיבה**: שם הגיבוי לא קיים
- **פתרון**: בדוק את רשימת הגיבויים הזמינים

#### "Failed to create backup"
- **סיבה**: בעיה בכתיבה לדיסק או חיבור ל-KV
- **פתרון**: בדוק הרשאות כתיבה וקישוריות

### 🔍 בדיקת תקינות
```bash
# בדיקת חיבור ל-API
curl -X GET "http://localhost:3001/api/backup?action=list"

# בדיקת גיבוי ספציפי
ls -la ./backups/backup-YYYY-MM-DDTHH-MM-SS-sssZ/
```

## תחזוקה מומלצת

### 📅 לוח זמנים מומלץ
- **יומי**: בדיקת יצירת גיבויים אוטומטיים
- **שבועי**: ניקוי גיבויים ישנים (מעל 30 יום)
- **חודשי**: העתקת גיבויים למקום חיצוני

### 💾 ניהול מקום דיסק
```bash
# בדיקת גודל תיקיית הגיבויים
du -sh ./backups/

# מחיקת גיבויים ישנים (מעל 30 יום)
find ./backups/ -type d -name "backup-*" -mtime +30 -exec rm -rf {} \;
```

## תמיכה ועזרה

### 📞 במקרה של בעיה
1. בדוק את הלוגים בקונסול הדפדפן
2. בדוק את הלוגים בשרת
3. ודא שהשרת רץ על הפורט הנכון
4. בדוק הרשאות כתיבה לתיקיית הגיבויים

### 🔧 הגדרות מתקדמות
להתאמות נוספות, ערוך את הקבצים:
- `app/api/backup/route.js` - לוגיקת הגיבוי
- `src/lib/data-manager.ts` - גיבוי אוטומטי
- `scripts/backup-manager.js` - סקריפט הטרמינל

---

**⚠️ חשוב**: תמיד בדוק את תקינות הנתונים לאחר שחזור מגיבוי!
